<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Dashboard | Dept Info Board</title>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#1E1B4B',
            accent: '#38BDF8',
            background: '#F8FAFC',
          }
        }
      }
    }
  </script>
</head>
<body class="bg-background text-gray-800 font-sans">

<!-- ‚úÖ Navbar (centered title + back button) -->
<nav class="bg-primary text-white shadow-md fixed w-full z-40 h-20 flex items-center justify-center relative px-6">
  <!-- Centered Title -->
  <h1 class="text-xl font-bold text-center absolute left-1/2 transform -translate-x-1/2">
    Dept Info Board ‚Äì Admin Dashboard
  </h1>

  <!-- Back to Login Page Button -->
  <a href="login.html"
     class="absolute right-6 bg-accent text-primary px-3 py-2 rounded-lg font-semibold hover:bg-accent/80 flex items-center">
    <!-- Mobile Icon -->
    <span class="block md:hidden text-lg">‚Üê</span>
    <!-- Desktop Text -->
    <span class="hidden md:block">‚Üê Logout</span>
  </a>
</nav>

  <!-- ‚úÖ Main Layout -->
  <main class="pt-24 px-6 flex flex-col md:flex-row gap-6">

    <!-- Sidebar -->
    <aside class="bg-white shadow-md rounded-lg p-6 w-full md:w-1/4 h-fit space-y-4">
      <h2 class="text-lg font-semibold text-primary mb-4">Manage</h2>
      <nav class="flex flex-col space-y-2">
        <button class="tab-btn text-left px-3 py-2 rounded-lg hover:bg-accent/20 active" data-tab="announcements">üì¢ Announcements</button>
        <button class="tab-btn text-left px-3 py-2 rounded-lg hover:bg-accent/20" data-tab="events">üé§ Events</button>
        <button class="tab-btn text-left px-3 py-2 rounded-lg hover:bg-accent/20" data-tab="timetables">üìò Timetables</button>
        <button class="tab-btn text-left px-3 py-2 rounded-lg hover:bg-accent/20" data-tab="archive">üóÇ Archive</button>
      </nav>
    </aside>

    <!-- Content Area -->
    <section class="flex-1 bg-white shadow-md rounded-lg p-6">
      <!-- Announcements -->
      <div id="announcements" class="tab-content">
        <h2 class="text-2xl font-bold text-primary mb-6">Manage Announcements</h2>
        <form id="announcementForm" class="space-y-4 mb-6">
          <input type="text" placeholder="Title" name="title" required class="w-full px-4 py-2 border rounded-lg">
          <textarea placeholder="Content" name="content" required class="w-full px-4 py-2 border rounded-lg"></textarea>
          <select name="level" class="w-full px-4 py-2 border rounded-lg">
            <option value="all">All Levels</option>
            <option value="100L">100 Level</option>
            <option value="200L">200 Level</option>
            <option value="300L">300 Level</option>
            <option value="400L">400 Level</option>
            <option value="500L">500 Level</option>
          </select>
          <button type="submit" class="bg-primary text-accent px-4 py-2 rounded-lg">Post Announcement</button>
        </form>
        <div id="announcementList" class="space-y-4"></div>
      </div>

      <!-- Events -->
      <div id="events" class="tab-content hidden">
        <h2 class="text-2xl font-bold text-primary mb-6">Manage Events</h2>
        <form id="eventForm" class="space-y-4 mb-6">
          <input type="text" placeholder="Title" name="title" required class="w-full px-4 py-2 border rounded-lg">
          <textarea placeholder="Details" name="content" required class="w-full px-4 py-2 border rounded-lg"></textarea>
          <input type="date" name="date" required class="w-full px-4 py-2 border rounded-lg">
          <select name="level" class="w-full px-4 py-2 border rounded-lg">
            <option value="all">All Levels</option>
            <option value="100L">100 Level</option>
            <option value="200L">200 Level</option>
            <option value="300L">300 Level</option>
            <option value="400L">400 Level</option>
            <option value="500L">500 Level</option>
          </select>
          <button type="submit" class="bg-primary text-accent px-4 py-2 rounded-lg">Add Event</button>
        </form>
        <div id="eventList" class="space-y-4"></div>
      </div>

      <!-- Timetables -->
      <div id="timetables" class="tab-content hidden">
        <h2 class="text-2xl font-bold text-primary mb-6">Manage Timetables</h2>
        <form id="timetableForm" class="space-y-4 mb-6">
          <input type="text" placeholder="Title" name="title" required class="w-full px-4 py-2 border rounded-lg">
          <input type="date" name="date" required class="w-full px-4 py-2 border rounded-lg">
          <select name="level" class="w-full px-4 py-2 border rounded-lg">
            <option value="100L">100 Level</option>
            <option value="200L">200 Level</option>
            <option value="300L">300 Level</option>
            <option value="400L">400 Level</option>
            <option value="500L">500 Level</option>
          </select>
          <input type="file" name="file" accept=".pdf,.jpg,.png" required class="w-full px-4 py-2 border rounded-lg">
          <button type="submit" class="bg-primary text-accent px-4 py-2 rounded-lg">Upload Timetable</button>
        </form>
        <div id="timetableList" class="space-y-4"></div>
      </div>

      <!-- Archive -->
      <div id="archive" class="tab-content hidden">
        <h2 class="text-2xl font-bold text-primary mb-6">Manage Archive</h2>
        <p class="text-gray-600 mb-4">Archived items are stored automatically when outdated. You can also manually move or delete items here.</p>
        <div id="archiveList" class="space-y-4"></div>
      </div>
    </section>

  <!-- ‚úÖ Edit Post Modal -->
<div id="editModal" class="hidden fixed inset-0 bg-black/50 flex justify-center items-center">
  <div class="bg-white p-6 rounded-xl shadow-xl w-full max-w-lg">
    <h2 class="text-xl font-bold mb-4">Edit Post</h2>
    <form id="editPostForm" class="space-y-4">
      <input type="text" id="editTitle" placeholder="Title" class="w-full border p-2 rounded" required>
      <textarea id="editContent" placeholder="Content" class="w-full border p-2 rounded" required></textarea>
      <input type="text" id="editLevel" placeholder="Level (all, 100L, 200L, ...)" class="w-full border p-2 rounded">
      <input type="date" id="editDate" class="w-full border p-2 rounded">
      
      <div class="flex justify-end gap-2">
        <button type="button" id="cancelEdit" class="px-4 py-2 bg-gray-400 text-white rounded">Cancel</button>
        <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded">Save</button>
      </div>
    </form>
  </div>
</div>

  </main>

  <!-- ‚úÖ JS -->
<script>
  // Safe escaping for HTML text to prevent XSS
  function escapeHtml(text) {
    const map = { "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#039;" };
    return text ? text.replace(/[&<>"']/g, m => map[m]) : "";
  }

  // Render post with action buttons
  function renderPost(post, type) {
    const dateVal = post.date ? new Date(post.date).toISOString().slice(0, 10) : "";
    return `
      <div class="p-4 border rounded-lg shadow"
           data-id="${post._id}"
           data-title="${encodeURIComponent(post.title || "")}"
           data-content="${encodeURIComponent(post.content || "")}"
           data-level="${post.level || "all"}"
           data-date="${dateVal}"
           data-type="${post.type || ""}"
           data-status="${post.status || "active"}">

        <h3 class="font-bold">${escapeHtml(post.title)}</h3>
        <p>${escapeHtml(post.content || "")}</p>
        ${post.date ? `<p class="text-sm text-gray-500">${new Date(post.date).toLocaleDateString()}</p>` : ""}
        <p class="text-sm text-gray-500">Level: ${post.level}</p>

        <div class="mt-2 flex gap-2">
          <button onclick="editPost('${post._id}')" class="px-3 py-1 bg-blue-500 text-white rounded">Edit</button>
          <button onclick="archivePost('${post._id}')" class="px-3 py-1 bg-yellow-500 text-white rounded">Archive</button>
          <button onclick="deletePost('${post._id}', '${type}')" class="px-3 py-1 bg-red-500 text-white rounded">Delete</button>
        </div>
      </div>
    `;
  }


  
// Edit entire post (prefill using rendered data-* attributes)
window.editPost = async function (id) {
  try {
    const el = document.querySelector(`[data-id="${id}"]`);
    if (!el) {
      alert("Post element not found in DOM. Refreshing list...");
      return loadPosts();
    }

    const current = {
      title: el.dataset.title,
      content: el.dataset.content,
      level: el.dataset.level || "all",
      date: el.dataset.date || ""
    };

    const newTitle = prompt("Edit title:", current.title);
    if (newTitle === null) return; // cancelled

    const newContent = prompt("Edit content:", current.content);
    if (newContent === null) return;

    const newLevel = prompt("Edit level (all, 100L, 200L, 300L, 400L, 500L):", current.level);
    if (newLevel === null) return;

    const newDate = prompt("Edit date (YYYY-MM-DD) or leave blank:", current.date);
    if (newDate === null) return;

    const payload = {
      title: newTitle,
      content: newContent,
      level: newLevel || "all",
      date: newDate || undefined
    };

    const res = await apiRequest(`${API_BASE}/${id}`, "PUT", payload);
    if (res && res.item) {
      alert("Post updated!");
      await loadPosts();
    } else {
      throw new Error("Unexpected server response.");
    }
  } catch (err) {
    console.error("editPost error:", err);
    alert("Error updating post: " + err.message);
  }
};

// Archive post
async function archivePost(id) {
  try {
    const res = await apiRequest(`${API_BASE}/${id}/status`, "PATCH", { status: "archived" });
    if (res.item) {
      alert("‚úÖ Post archived!");
      loadPosts();
    } else {
      throw new Error("Invalid response from server");
    }
  } catch (err) {
    alert("‚ùå Error archiving: " + err.message);
  }
}

// Unarchive post
async function unarchivePost(id) {
  try {
    await apiRequest(`${API_BASE}/${id}/status`, "PATCH", { status: "active" });
    alert("Post restored!");
    loadPosts();
  } catch (err) {
    alert("Error unarchiving: " + err.message);
  }
}

// Delete post
async function deletePost(id, type) {
  if (!confirm("Are you sure you want to delete this post?")) return;

  try {
    const res = await apiRequest(`${API_BASE}/${id}`, "DELETE");
    if (res.message === "Deleted") {
      alert("üóëÔ∏è Post deleted!");
      loadPosts();
    } else {
      throw new Error("Invalid response from server");
    }
  } catch (err) {
    alert("‚ùå Error deleting: " + err.message);
  }
}

  // üîí Security: check for token
  const token = localStorage.getItem("token");
  if (!token) {
    window.location.href = "login.html"; // No token? Redirect to login
  }

  // ----------------------
  // API base URL
  // ----------------------
  const API_BASE = "http://localhost:4000/api/posts";

  // ----------------------
  // Tab Switching
  // ----------------------
  const tabs = document.querySelectorAll(".tab-btn");
  const contents = document.querySelectorAll(".tab-content");

  tabs.forEach(tab => {
    tab.addEventListener("click", () => {
      tabs.forEach(btn => btn.classList.remove("active", "bg-accent/20"));
      tab.classList.add("active", "bg-accent/20");

      contents.forEach(c => c.classList.add("hidden"));
      document.getElementById(tab.dataset.tab).classList.remove("hidden");
    });
  });

  // ----------------------
  // Logout
  // ----------------------
  document.querySelector("a[href='login.html']").id = "logoutBtn"; // attach id
  document.getElementById("logoutBtn").addEventListener("click", (e) => {
    e.preventDefault();
    localStorage.removeItem("token");
    localStorage.removeItem("username");
    window.location.href = "login.html";
  });

  // ----------------------
  // Helper: API call with token
  // ----------------------
  async function apiRequest(url, method = "GET", body, isFile = false) {
    const options = { method, headers: {} };

    if (isFile) {
      options.headers["Authorization"] = `Bearer ${token}`;
      options.body = body;
    } else if (method !== "GET") {
      options.headers = {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${token}`
      };
      options.body = JSON.stringify(body);
    } else {
      options.headers["Authorization"] = `Bearer ${token}`;
    }

    const res = await fetch(url, options);
    if (!res.ok) {
      const msg = await res.text();
      throw new Error(msg || "Request failed");
    }
    return res.json();
  }

  // ----------------------
  // DOM elements
  // ----------------------
  const announcementForm = document.getElementById("announcementForm");
  const announcementList = document.getElementById("announcementList");
  const eventForm = document.getElementById("eventForm");
  const eventList = document.getElementById("eventList");
  const timetableForm = document.getElementById("timetableForm");
  const timetableList = document.getElementById("timetableList");

// ----------------------
// Load posts on page load
// ----------------------
async function loadPosts() {
  try {
    // 1Ô∏è‚É£ Load active posts
    const response = await apiRequest(API_BASE, "GET");
    const posts = response.items || [];

    // Clear lists first
    announcementList.innerHTML = "";
    eventList.innerHTML = "";
    timetableList.innerHTML = "";
    archiveList.innerHTML = "";

    posts.forEach(post => {
      if (post.type === "announcement") {
        announcementList.innerHTML += renderPost(post, "announcement");
      } else if (post.type === "event") {
        eventList.innerHTML += renderPost(post, "event");
      } else if (post.type === "timetable") {
        timetableList.innerHTML += renderPost(post, "timetable");
      }
    });

    // 2Ô∏è‚É£ Load archived posts
    const archivedRes = await apiRequest(`${API_BASE}?status=archived`, "GET");
    const archived = archivedRes.items || [];

    archived.forEach(post => {
      archiveList.innerHTML += `
        <div class="p-4 border rounded-lg shadow bg-yellow-50">
          <h3 class="font-bold">${post.title}</h3>
          <p>${post.content || ""}</p>
          <p class="text-sm text-gray-500">Level: ${post.level}</p>
          <div class="mt-2 flex gap-2">
            <button onclick="unarchivePost('${post._id}')" 
              class="px-3 py-1 bg-green-500 text-white rounded">Unarchive</button>
            <button onclick="deletePost('${post._id}', 'archive')" 
              class="px-3 py-1 bg-red-500 text-white rounded">Delete</button>
          </div>
        </div>
      `;
    });

  } catch (err) {
    console.error("Error loading posts:", err);
    alert("Failed to load posts: " + err.message);
  }
}

  // ----------------------
  // Announcements Form
  // ----------------------
  announcementForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    const formData = {
      title: announcementForm.title.value,
      content: announcementForm.content.value,
      type: "announcement",
      level: announcementForm.level.value
    };

    try {
      await apiRequest(API_BASE, "POST", formData);
      announcementForm.reset();
      loadPosts(); // refresh list
    } catch (err) {
      alert("Error posting announcement: " + err.message);
    }
  });

  // ----------------------
  // Events Form
  // ----------------------
  eventForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    const formData = {
      title: eventForm.title.value,
      content: eventForm.content.value,
      date: eventForm.date.value,
      type: "event",
      level: eventForm.level.value
    };

    try {
      await apiRequest(API_BASE, "POST", formData);
      eventForm.reset();
      loadPosts(); // refresh list
    } catch (err) {
      alert("Error posting event: " + err.message);
    }
  });

  // ----------------------
  // Timetables Form
  // ----------------------
  timetableForm.addEventListener("submit", async (e) => {
    e.preventDefault();

    const formData = new FormData(timetableForm);
    formData.append("type", "timetable");

    try {
      await apiRequest(API_BASE, "POST", formData, true);
      timetableForm.reset();
      loadPosts(); // refresh list
    } catch (err) {
      alert("Error uploading timetable: " + err.message);
    }
  });

  // ----------------------
  // Initialize
  // ----------------------
  loadPosts();
</script>

<script>
window.editPost = async function (id) {
  try {
    const el = document.querySelector(`[data-id="${id}"]`);
    if (!el) {
      alert("Post element not found in DOM. Refreshing list...");
      return loadPosts();
    }

    // ‚úÖ Decode URI components for proper display
    const current = {
      title: decodeURIComponent(el.dataset.title),
      content: decodeURIComponent(el.dataset.content),
      level: el.dataset.level || "all",
      date: el.dataset.date || ""
    };

    // Populate modal form
    document.getElementById("editTitle").value = current.title;
    document.getElementById("editContent").value = current.content;
    document.getElementById("editLevel").value = current.level;
    document.getElementById("editDate").value = current.date;

    // Show modal
    document.getElementById("editModal").classList.remove("hidden");

    // ‚úÖ Attach submit handler dynamically
    const form = document.getElementById("editPostForm");
    form.onsubmit = async (e) => {
      e.preventDefault();

      const payload = {
        title: document.getElementById("editTitle").value,
        content: document.getElementById("editContent").value,
        level: document.getElementById("editLevel").value || "all",
        date: document.getElementById("editDate").value || undefined
      };

      try {
        const res = await apiRequest(`${API_BASE}/${id}`, "PUT", payload);
        if (res && res.item) {
          alert("‚úÖ Post updated!");
          document.getElementById("editModal").classList.add("hidden");
          await loadPosts();
        } else {
          throw new Error("Unexpected server response.");
        }
      } catch (err) {
        console.error("editPost error:", err);
        alert("Error updating post: " + err.message);
      }
    };

    // Cancel button closes modal
    document.getElementById("cancelEdit").onclick = () => {
      document.getElementById("editModal").classList.add("hidden");
    };

  } catch (err) {
    console.error("editPost error:", err);
    alert("Error loading post data: " + err.message);
  }
};
</script>

</body>
</html>
